<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import Products - SanaSBMT Admin</title>
    <link rel="stylesheet" href="../public/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <aside class="admin-sidebar">
            <h2>SanaSBMT Admin</h2>
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="add-product.html"><i class="fas fa-plus-circle"></i> Add Product</a></li>
                <li><a href="view-products.html"><i class="fas fa-boxes"></i> View Products</a></li>
                <li class="active"><a href="import-products.html"><i class="fas fa-file-import"></i> Import Products</a></li>
                <li><a href="#" id="logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </aside>
        <main class="admin-main">
            <h1><i class="fas fa-file-import"></i> Import Products</h1>
            
            <div class="import-options">
                <div class="import-option">
                    <h3><i class="fas fa-file-csv"></i> CSV Import</h3>
                    <p>Upload a CSV file with your product data. Download our template file to ensure proper formatting.</p>
                    <form id="csvImportForm">
                        <div class="form-group">
                            <label for="csvFile">Select CSV File</label>
                            <input type="file" id="csvFile" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-upload"></i> Import CSV</button>
                        <a href="#" id="downloadTemplate" class="btn btn-secondary"><i class="fas fa-download"></i> Download Template</a>
                    </form>
                </div>
                
                <div class="import-option">
                    <h3><i class="fas fa-file-excel"></i> Excel Import</h3>
                    <p>Upload an Excel file (XLSX) with your product data. Ensure the columns match our template.</p>
                    <form id="excelImportForm">
                        <div class="form-group">
                            <label for="excelFile">Select Excel File</label>
                            <input type="file" id="excelFile" accept=".xlsx, .xls" required>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-upload"></i> Import Excel</button>
                    </form>
                </div>
                
                <div class="import-option">
                    <h3><i class="fas fa-code"></i> JSON Import</h3>
                    <p>Paste your product data in JSON format or upload a JSON file.</p>
                    <form id="jsonImportForm">
                        <div class="form-group">
                            <label for="jsonData">JSON Data</label>
                            <textarea id="jsonData" rows="10" placeholder='[{"name":"Product 1","price":19.99,"category":"electronics",...}]'></textarea>
                        </div>
                        <div class="form-group">
                            <label for="jsonFile">Or upload JSON file</label>
                            <input type="file" id="jsonFile" accept=".json">
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-upload"></i> Import JSON</button>
                    </form>
                </div>
            </div>
            
            <div id="importResults" class="import-results">
                <!-- Results will be shown here -->
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const db = firebase.firestore();
            
            // Download template
            document.getElementById('downloadTemplate').addEventListener('click', function(e) {
                e.preventDefault();
                
                const csvContent = "name,price,category,description,image,featured\n" +
                                  "Product 1,19.99,electronics,Description 1,image1.jpg,true\n" +
                                  "Product 2,29.99,clothing,Description 2,image2.jpg,false";
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'product_import_template.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // CSV Import
            document.getElementById('csvImportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const file = document.getElementById('csvFile').files[0];
                
                if (!file) return;
                
                Papa.parse(file, {
                    header: true,
                    complete: function(results) {
                        importProducts(results.data, 'CSV');
                    },
                    error: function(error) {
                        showImportError('Error parsing CSV file: ' + error.message);
                    }
                });
            });
            
            // Excel Import
            document.getElementById('excelImportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const file = document.getElementById('excelFile').files[0];
                
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    importProducts(jsonData, 'Excel');
                };
                reader.readAsArrayBuffer(file);
            });
            
            // JSON Import
            document.getElementById('jsonImportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const jsonInput = document.getElementById('jsonData').value;
                const jsonFile = document.getElementById('jsonFile').files[0];
                
                if (jsonFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            importProducts(jsonData, 'JSON File');
                        } catch (error) {
                            showImportError('Error parsing JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(jsonFile);
                } else if (jsonInput) {
                    try {
                        const jsonData = JSON.parse(jsonInput);
                        importProducts(jsonData, 'JSON Input');
                    } catch (error) {
                        showImportError('Error parsing JSON input: ' + error.message);
                    }
                } else {
                    showImportError('Please provide JSON data or upload a JSON file');
                }
            });
            
            // Import products to Firestore
            function importProducts(products, source) {
                const resultsDiv = document.getElementById('importResults');
                resultsDiv.innerHTML = '<div class="import-status"><i class="fas fa-spinner fa-spin"></i> Importing products...</div>';
                
                let successCount = 0;
                let errorCount = 0;
                const errorMessages = [];
                
                // Batch import to reduce write operations
                const batch = db.batch();
                const productsCollection = db.collection('products');
                const batchSize = 500; // Firestore limit per batch
                let batchCount = 0;
                
                // Process products in batches
                for (let i = 0; i < products.length; i++) {
                    const product = products[i];
                    
                    // Validate required fields
                    if (!product.name || !product.price) {
                        errorCount++;
                        errorMessages.push(`Row ${i+1}: Missing required fields (name or price)`);
                        continue;
                    }
                    
                    // Clean and prepare product data
                    const cleanProduct = {
                        name: String(product.name || ''),
                        price: parseFloat(product.price) || 0,
                        category: String(product.category || ''),
                        description: String(product.description || ''),
                        image: String(product.image || ''),
                        featured: Boolean(product.featured) || false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Add to batch
                    const newDocRef = productsCollection.doc();
                    batch.set(newDocRef, cleanProduct);
                    batchCount++;
                    successCount++;
                    
                    // Commit batch if we reach batch size
                    if (batchCount >= batchSize) {
                        batch.commit()
                            .catch(error => {
                                console.error('Batch error: ', error);
                                errorCount += batchCount;
                                errorMessages.push(`Batch error: ${error.message}`);
                            });
                        batchCount = 0;
                    }
                }
                
                // Commit any remaining documents in the batch
                if (batchCount > 0) {
                    batch.commit()
                        .then(() => {
                            showImportResults(successCount, errorCount, errorMessages, source);
                        })
                        .catch(error => {
                            console.error('Final batch error: ', error);
                            errorCount += batchCount;
                            errorMessages.push(`Final batch error: ${error.message}`);
                            showImportResults(successCount - batchCount, errorCount, errorMessages, source);
                        });
                } else {
                    showImportResults(successCount, errorCount, errorMessages, source);
                }
            }
            
            function showImportResults(successCount, errorCount, errorMessages, source) {
                const resultsDiv = document.getElementById('importResults');
                let html = `
                    <div class="import-summary">
                        <h3>Import Results (${source})</h3>
                        <p class="success"><i class="fas fa-check-circle"></i> ${successCount} products imported successfully</p>
                        <p class="${errorCount ? 'error' : 'success'}"><i class="fas ${errorCount ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> ${errorCount} errors</p>
                `;
                
                if (errorCount > 0) {
                    html += `
                        <div class="error-details">
                            <h4>Error Details:</h4>
                            <ul>
                                ${errorMessages.map(msg => `<li>${msg}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                html += `</div>`;
                resultsDiv.innerHTML = html;
            }
            
            function showImportError(message) {
                const resultsDiv = document.getElementById('importResults');
                resultsDiv.innerHTML = `<div class="import-error"><i class="fas fa-exclamation-circle"></i> ${message}</div>`;
            }
        });
    </script>
</body>
</html>